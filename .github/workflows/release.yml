# Release workflow for terraform-provider-garage
#
# Triggered on:
#   - Push of semantic version tags (v1.0.0, v0.1.0, etc.)
#   - Manual dispatch via GitHub UI
#
# This workflow:
#   1. Builds binaries for all supported platforms
#   2. Creates SHA256 checksums
#   3. Signs checksums with GPG
#   4. Uploads release artifacts to GitHub

name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'  # Matches v1.0.0, v0.1.0-alpha, etc.
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write
  packages: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: false

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  verify:
    runs-on: ubuntu-latest
    needs: goreleaser
    if: always()
    steps:
      - name: Verify release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.inputs.tag || github.ref_name }}"
          echo "Verifying release for tag: $TAG"

          # Wait for release to be available
          sleep 10

          # Check release exists and has expected assets
          gh release view "$TAG" --repo "${{ github.repository }}" --json assets,tagName,name

          echo "Release verification complete"
